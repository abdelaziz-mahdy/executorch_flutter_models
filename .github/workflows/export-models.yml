name: Export Models

on:
  push:
    branches:
      - main
    paths:
      - 'python/**'
  workflow_dispatch:
    inputs:
      executorch_versions:
        description: 'ExecuTorch versions to export (comma-separated or "all")'
        required: true
        default: 'all'
        type: choice
        options:
          - 'all'
          - '1.0.1'
          - '1.1.0'
      models:
        description: 'Models to export'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - mobilenet
          - yolo
          - yolo-pose
          - yolo-face
      backends:
        description: 'Backends to use'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - xnnpack
          - coreml
          - mps
          - vulkan

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Determine which versions to build
  setup:
    runs-on: ubuntu-latest
    outputs:
      versions: ${{ steps.set-versions.outputs.versions }}
    steps:
      - name: Set versions matrix
        id: set-versions
        run: |
          INPUT="${{ github.event.inputs.executorch_versions }}"
          if [ -z "$INPUT" ] || [ "$INPUT" == "all" ]; then
            echo 'versions=["1.0.1", "1.1.0"]' >> $GITHUB_OUTPUT
          else
            echo "versions=[\"$INPUT\"]" >> $GITHUB_OUTPUT
          fi

  # Linux job: exports xnnpack and vulkan backends
  export-linux:
    runs-on: ubuntu-latest
    needs: setup
    if: github.event.inputs.backends == 'all' || github.event.inputs.backends == 'xnnpack' || github.event.inputs.backends == 'vulkan' || github.event.inputs.backends == ''
    strategy:
      fail-fast: false
      matrix:
        version: ${{ fromJson(needs.setup.outputs.versions) }}

    steps:
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          # OpenGL libraries required by OpenCV/ultralytics
          sudo apt-get update
          sudo apt-get install -y libgl1 libglib2.0-0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: python/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip

          # Install executorch first (pulls correct torch version)
          pip install executorch==${{ matrix.version }}

          # Get torch version installed by executorch
          TORCH_VERSION=$(python -c "import torch; print(torch.__version__.split('+')[0])")
          echo "Torch version from executorch: $TORCH_VERSION"

          # Install compatible torchvision based on torch version
          # torch 2.9.x -> torchvision 0.24.x
          # torch 2.10.x -> torchvision 0.25.x
          # torch 2.6.x -> torchvision 0.21.x
          # torch 2.5.x -> torchvision 0.20.x
          # torch 2.4.x -> torchvision 0.19.x
          if [[ "$TORCH_VERSION" == 2.9.* ]]; then
            pip install "torchvision>=0.24.0,<0.25.0"
          elif [[ "$TORCH_VERSION" == 2.10.* ]]; then
            pip install "torchvision>=0.25.0,<0.26.0"
          elif [[ "$TORCH_VERSION" == 2.6.* ]]; then
            pip install "torchvision>=0.21.0,<0.22.0"
          elif [[ "$TORCH_VERSION" == 2.5.* ]]; then
            pip install "torchvision>=0.20.0,<0.21.0"
          elif [[ "$TORCH_VERSION" == 2.4.* ]]; then
            pip install "torchvision>=0.19.0,<0.20.0"
          else
            # Fallback: install without deps to avoid torch upgrade
            pip install --no-deps torchvision
          fi

          # Install remaining requirements (excluding torchvision which is already installed)
          pip install ultralytics>=8.3.0 onnx>=1.20.0 onnx2torch>=1.5.0 numpy pillow

          # Verify versions
          echo "=== Installed versions ==="
          python -c "import torch; print(f'torch: {torch.__version__}')"
          python -c "import torchvision; print(f'torchvision: {torchvision.__version__}')"
          pip show executorch | grep Version || echo "executorch version check skipped"

      - name: Parse inputs
        id: parse
        run: |
          MODELS="${{ github.event.inputs.models }}"
          BACKENDS="${{ github.event.inputs.backends }}"

          if [ -z "$MODELS" ]; then
            MODELS="all"
          fi

          # Linux backends: xnnpack and vulkan
          if [ -z "$BACKENDS" ] || [ "$BACKENDS" == "all" ]; then
            BACKENDS="xnnpack vulkan"
          elif [ "$BACKENDS" == "coreml" ] || [ "$BACKENDS" == "mps" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "models=$MODELS" >> $GITHUB_OUTPUT
          echo "backends=$BACKENDS" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Create version directory
        if: steps.parse.outputs.skip != 'true'
        run: |
          mkdir -p ${{ matrix.version }}/mobilenet
          mkdir -p ${{ matrix.version }}/yolo
          mkdir -p ${{ matrix.version }}/yolo-pose
          mkdir -p ${{ matrix.version }}/yolo-face

      - name: Export MobileNet
        if: steps.parse.outputs.skip != 'true' && (steps.parse.outputs.models == 'mobilenet' || steps.parse.outputs.models == 'all')
        working-directory: python
        run: |
          python main.py export --mobilenet --backends ${{ steps.parse.outputs.backends }} --output-dir ../${{ matrix.version }}

      - name: Export YOLO (all variants)
        if: steps.parse.outputs.skip != 'true' && (steps.parse.outputs.models == 'yolo' || steps.parse.outputs.models == 'all')
        working-directory: python
        run: |
          python main.py export --yolo yolo11n --backends ${{ steps.parse.outputs.backends }} --output-dir ../${{ matrix.version }}
          python main.py export --yolo yolov8n --backends ${{ steps.parse.outputs.backends }} --output-dir ../${{ matrix.version }}
          python main.py export --yolo yolov5n --backends ${{ steps.parse.outputs.backends }} --output-dir ../${{ matrix.version }}

      - name: Export YOLO-Pose (all variants)
        if: steps.parse.outputs.skip != 'true' && (steps.parse.outputs.models == 'yolo-pose' || steps.parse.outputs.models == 'all')
        working-directory: python
        run: |
          python main.py export --yolo-pose yolo11n-pose --backends ${{ steps.parse.outputs.backends }} --output-dir ../${{ matrix.version }}
          python main.py export --yolo-pose yolov8n-pose --backends ${{ steps.parse.outputs.backends }} --output-dir ../${{ matrix.version }}

      - name: Export YOLO-Face (all variants)
        if: steps.parse.outputs.skip != 'true' && (steps.parse.outputs.models == 'yolo-face' || steps.parse.outputs.models == 'all')
        working-directory: python
        run: |
          python main.py export --yolo-face yolov11n-face --backends ${{ steps.parse.outputs.backends }} --output-dir ../${{ matrix.version }}
          python main.py export --yolo-face yolov10n-face --backends ${{ steps.parse.outputs.backends }} --output-dir ../${{ matrix.version }}

      - name: List exported files before upload
        if: steps.parse.outputs.skip != 'true'
        run: |
          echo "=== Files to upload for version ${{ matrix.version }} ==="
          find ${{ matrix.version }} -name "*.pte" -type f
          echo "=== Directory structure ==="
          ls -la ${{ matrix.version }}/

      - name: Upload Linux artifacts
        if: steps.parse.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: models-linux-${{ matrix.version }}
          path: ${{ matrix.version }}
          retention-days: 1

  # macOS job: exports xnnpack, coreml, mps, and vulkan backends
  export-macos:
    runs-on: macos-latest
    needs: setup
    if: github.event.inputs.backends == 'all' || github.event.inputs.backends == 'xnnpack' || github.event.inputs.backends == 'coreml' || github.event.inputs.backends == 'mps' || github.event.inputs.backends == 'vulkan' || github.event.inputs.backends == ''
    strategy:
      fail-fast: false
      matrix:
        version: ${{ fromJson(needs.setup.outputs.versions) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: python/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip

          # Install executorch first (pulls correct torch version)
          pip install executorch==${{ matrix.version }}

          # Get torch version installed by executorch
          TORCH_VERSION=$(python -c "import torch; print(torch.__version__.split('+')[0])")
          echo "Torch version from executorch: $TORCH_VERSION"

          # Install compatible torchvision based on torch version
          # torch 2.9.x -> torchvision 0.24.x
          # torch 2.10.x -> torchvision 0.25.x
          # torch 2.6.x -> torchvision 0.21.x
          # torch 2.5.x -> torchvision 0.20.x
          # torch 2.4.x -> torchvision 0.19.x
          if [[ "$TORCH_VERSION" == 2.9.* ]]; then
            pip install "torchvision>=0.24.0,<0.25.0"
          elif [[ "$TORCH_VERSION" == 2.10.* ]]; then
            pip install "torchvision>=0.25.0,<0.26.0"
          elif [[ "$TORCH_VERSION" == 2.6.* ]]; then
            pip install "torchvision>=0.21.0,<0.22.0"
          elif [[ "$TORCH_VERSION" == 2.5.* ]]; then
            pip install "torchvision>=0.20.0,<0.21.0"
          elif [[ "$TORCH_VERSION" == 2.4.* ]]; then
            pip install "torchvision>=0.19.0,<0.20.0"
          else
            # Fallback: install without deps to avoid torch upgrade
            pip install --no-deps torchvision
          fi

          # Install remaining requirements (excluding torchvision which is already installed)
          pip install ultralytics>=8.3.0 onnx>=1.20.0 onnx2torch>=1.5.0 numpy pillow

          # Verify versions
          echo "=== Installed versions ==="
          python -c "import torch; print(f'torch: {torch.__version__}')"
          python -c "import torchvision; print(f'torchvision: {torchvision.__version__}')"
          pip show executorch | grep Version || echo "executorch version check skipped"

      - name: Parse inputs
        id: parse
        run: |
          MODELS="${{ github.event.inputs.models }}"
          BACKENDS="${{ github.event.inputs.backends }}"

          if [ -z "$MODELS" ]; then
            MODELS="all"
          fi

          # macOS backends: xnnpack, coreml, mps, and vulkan
          if [ -z "$BACKENDS" ] || [ "$BACKENDS" == "all" ]; then
            BACKENDS="xnnpack coreml mps vulkan"
          fi

          echo "models=$MODELS" >> $GITHUB_OUTPUT
          echo "backends=$BACKENDS" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Create version directory
        if: steps.parse.outputs.skip != 'true'
        run: |
          mkdir -p ${{ matrix.version }}/mobilenet
          mkdir -p ${{ matrix.version }}/yolo
          mkdir -p ${{ matrix.version }}/yolo-pose
          mkdir -p ${{ matrix.version }}/yolo-face

      - name: Export MobileNet
        if: steps.parse.outputs.skip != 'true' && (steps.parse.outputs.models == 'mobilenet' || steps.parse.outputs.models == 'all')
        working-directory: python
        run: |
          python main.py export --mobilenet --backends ${{ steps.parse.outputs.backends }} --output-dir ../${{ matrix.version }}

      - name: Export YOLO (all variants)
        if: steps.parse.outputs.skip != 'true' && (steps.parse.outputs.models == 'yolo' || steps.parse.outputs.models == 'all')
        working-directory: python
        run: |
          python main.py export --yolo yolo11n --backends ${{ steps.parse.outputs.backends }} --output-dir ../${{ matrix.version }}
          python main.py export --yolo yolov8n --backends ${{ steps.parse.outputs.backends }} --output-dir ../${{ matrix.version }}
          python main.py export --yolo yolov5n --backends ${{ steps.parse.outputs.backends }} --output-dir ../${{ matrix.version }}

      - name: Export YOLO-Pose (all variants)
        if: steps.parse.outputs.skip != 'true' && (steps.parse.outputs.models == 'yolo-pose' || steps.parse.outputs.models == 'all')
        working-directory: python
        run: |
          python main.py export --yolo-pose yolo11n-pose --backends ${{ steps.parse.outputs.backends }} --output-dir ../${{ matrix.version }}
          python main.py export --yolo-pose yolov8n-pose --backends ${{ steps.parse.outputs.backends }} --output-dir ../${{ matrix.version }}

      - name: Export YOLO-Face (all variants)
        if: steps.parse.outputs.skip != 'true' && (steps.parse.outputs.models == 'yolo-face' || steps.parse.outputs.models == 'all')
        working-directory: python
        run: |
          python main.py export --yolo-face yolov11n-face --backends ${{ steps.parse.outputs.backends }} --output-dir ../${{ matrix.version }}
          python main.py export --yolo-face yolov10n-face --backends ${{ steps.parse.outputs.backends }} --output-dir ../${{ matrix.version }}

      - name: List exported files before upload
        if: steps.parse.outputs.skip != 'true'
        run: |
          echo "=== Files to upload for version ${{ matrix.version }} ==="
          find ${{ matrix.version }} -name "*.pte" -type f
          echo "=== Directory structure ==="
          ls -la ${{ matrix.version }}/

      - name: Upload macOS artifacts
        if: steps.parse.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: models-macos-${{ matrix.version }}
          path: ${{ matrix.version }}
          retention-days: 1

  # Commit job: combines artifacts and commits for all versions
  commit:
    runs-on: ubuntu-latest
    needs: [setup, export-linux, export-macos]
    if: always() && (needs.export-linux.result == 'success' || needs.export-macos.result == 'success')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded artifacts
        run: |
          echo "=== Downloaded artifacts ==="
          find artifacts -type f -name "*.pte" | head -50
          ls -la artifacts/

      - name: Merge artifacts into version directories
        run: |
          # Get versions from the setup job
          VERSIONS='${{ needs.setup.outputs.versions }}'
          echo "Processing versions: $VERSIONS"

          # Parse JSON array and iterate
          for VERSION in $(echo "$VERSIONS" | jq -r '.[]'); do
            echo "=== Processing version $VERSION ==="

            # Create version directory structure
            mkdir -p "$VERSION/mobilenet"
            mkdir -p "$VERSION/yolo"
            mkdir -p "$VERSION/yolo-pose"
            mkdir -p "$VERSION/yolo-face"

            # Copy Linux artifacts for this version
            if [ -d "artifacts/models-linux-$VERSION" ]; then
              echo "Copying Linux artifacts for $VERSION"
              cp -r artifacts/models-linux-$VERSION/* "$VERSION/" 2>/dev/null || true
            fi

            # Copy macOS artifacts for this version
            if [ -d "artifacts/models-macos-$VERSION" ]; then
              echo "Copying macOS artifacts for $VERSION"
              cp -r artifacts/models-macos-$VERSION/* "$VERSION/" 2>/dev/null || true
            fi

            echo "Files for $VERSION:"
            find "$VERSION" -name "*.pte" -type f | wc -l
          done

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download and copy labels
        run: |
          # Download labels if not present
          MOBILENET_LABELS_URL="https://raw.githubusercontent.com/pytorch/hub/master/imagenet_classes.txt"
          COCO_LABELS="person,bicycle,car,motorcycle,airplane,bus,train,truck,boat,traffic light,fire hydrant,stop sign,parking meter,bench,bird,cat,dog,horse,sheep,cow,elephant,bear,zebra,giraffe,backpack,umbrella,handbag,tie,suitcase,frisbee,skis,snowboard,sports ball,kite,baseball bat,baseball glove,skateboard,surfboard,tennis racket,bottle,wine glass,cup,fork,knife,spoon,bowl,banana,apple,sandwich,orange,broccoli,carrot,hot dog,pizza,donut,cake,chair,couch,potted plant,bed,dining table,toilet,tv,laptop,mouse,remote,keyboard,cell phone,microwave,oven,toaster,sink,refrigerator,book,clock,vase,scissors,teddy bear,hair drier,toothbrush"

          VERSIONS='${{ needs.setup.outputs.versions }}'
          for VERSION in $(echo "$VERSIONS" | jq -r '.[]'); do
            # MobileNet labels (ImageNet 1000 classes)
            if [ -d "$VERSION/mobilenet" ]; then
              curl -sL "$MOBILENET_LABELS_URL" -o "$VERSION/mobilenet/labels.txt" 2>/dev/null || true
            fi

            # YOLO labels (COCO 80 classes)
            if [ -d "$VERSION/yolo" ]; then
              echo "$COCO_LABELS" | tr ',' '\n' > "$VERSION/yolo/labels.txt"
            fi
          done

      - name: Update index.json for each version
        working-directory: python
        run: |
          VERSIONS='${{ needs.setup.outputs.versions }}'
          for VERSION in $(echo "$VERSIONS" | jq -r '.[]'); do
            echo "Generating index.json for $VERSION"
            python -c "
          import sys
          sys.path.insert(0, '.')
          from main import generate_index_json
          version = '$VERSION'
          generate_index_json(f'../{version}', version=version)
          " || echo "Warning: Could not generate index.json for $VERSION"
          done

      - name: List exported models
        run: |
          VERSIONS='${{ needs.setup.outputs.versions }}'
          for VERSION in $(echo "$VERSIONS" | jq -r '.[]'); do
            echo "=== Exported Models for version $VERSION ==="
            find "$VERSION" -name "*.pte" -type f -exec ls -lh {} \; 2>/dev/null || echo "No models found"
            echo ""
            if [ -f "$VERSION/index.json" ]; then
              echo "=== index.json summary for $VERSION ==="
              python -c "
          import json
          version = '$VERSION'
          try:
              with open(f'{version}/index.json') as f:
                  data = json.load(f)
              print(f'Total models: {len(data[\"models\"])}')
              for m in data['models']:
                  print(f'  - {m[\"name\"]} ({m[\"sizeMB\"]} MB)')
          except Exception as e:
              print(f'Error reading index.json: {e}')
          "
            fi
            echo ""
          done

      - name: Update versions.json
        env:
          VERSIONS_JSON: ${{ needs.setup.outputs.versions }}
        run: |
          python -c "
          import json
          import os

          versions_list = json.loads(os.environ['VERSIONS_JSON'])

          # Read current versions.json or create new
          try:
              with open('versions.json', 'r') as f:
                  data = json.load(f)
          except:
              data = {'versions': [], 'latest': None}

          # Ensure versions list exists
          if data.get('versions') is None:
              data['versions'] = []

          # Add versions if not present
          for version in versions_list:
              if version not in data['versions']:
                  data['versions'].append(version)

          # Sort versions
          data['versions'].sort()

          # Update latest to highest version
          if data['versions']:
              data['latest'] = data['versions'][-1]

          # Write back
          with open('versions.json', 'w') as f:
              json.dump(data, f, indent=2)

          print(f'Updated versions.json: {data}')
          "

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            MODELS="${{ github.event.inputs.models }}"
            BACKENDS="${{ github.event.inputs.backends }}"
            VERSIONS='${{ needs.setup.outputs.versions }}'
            [ -z "$MODELS" ] && MODELS="all"
            [ -z "$BACKENDS" ] && BACKENDS="all"

            # Format versions for commit message
            VERSION_STR=$(echo "$VERSIONS" | jq -r 'join(", ")')

            git commit -m "feat: Export models ($MODELS) with backends ($BACKENDS) for ExecuTorch $VERSION_STR"
            git push
          fi

      - name: Upload final artifacts
        uses: actions/upload-artifact@v4
        with:
          name: exported-models-all
          path: |
            1.0.1
            1.1.0
          retention-days: 30
